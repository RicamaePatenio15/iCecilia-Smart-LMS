{% extends 'base.html' %}
{% set active='staff' %}
{% block content %}

<h1>Pending Staff Registrations</h1>
<div class="card">
  {% if pending %}
    <table class="table table-staff">
      <thead>
        <tr>
          <th>Name</th>
          <th>Username</th>
          <th>Status</th>
          <th style="text-align:center">Action</th>
        </tr>
      </thead>
      <tbody>
      {% for u in pending %}
        <tr>
          <td>{{ u['first_name'] }} {{ u['last_name'] or '' }}</td>
          <td>{{ u['username'] }}</td>
          <td><span class="badge warn">{{ u['status'] }}</span></td>
          <td style="text-align:center">
            <form method="post" action="{{ url_for('approve_staff', user_id=u['user_id']) }}" style="display:inline">
              <button class="btn">Approve</button>
            </form>
            <form method="post" action="{{ url_for('deactivate_staff', user_id=u['user_id']) }}" style="display:inline">
              <button class="btn secondary">Reject</button>
            </form>
          </td>
        </tr>
      {% endfor %}
      </tbody>
    </table>
  {% else %}
    <p class="small">No pending registrations.</p>
  {% endif %}
</div>


<!-- ---- CURRENT STAFF SECTION ---- -->
<div class="staff-header">
  <h2 class="sub-heading">Current Library Staff</h2>

  <form id="filterForm" method="get" action="{{ url_for('staff_management') }}" class="filter-form">
    <label class="small" for="statusFilter">Filter by status:</label>
    <select name="status_filter" id="statusFilter" class="styled-select">
      <option value="all" {% if status_filter=='all' %}selected{% endif %}>All</option>
      <option value="active" {% if status_filter=='active' %}selected{% endif %}>Active</option>
      <option value="inactive" {% if status_filter=='inactive' %}selected{% endif %}>Inactive</option>
    </select>
  </form>
</div>

<div class="card">
  {% if staff %}
    <table class="table table-staff">
      <thead>
        <tr>
          <th>Name</th>
          <th style="width:140px;text-align:center">Status</th>
          <th style="width:220px;text-align:center">Action</th>
        </tr>
      </thead>
      <tbody>
      {% for u in staff %}
        <tr>
          <td>{{ u['first_name'] }} {{ u['last_name'] or '' }}</td>
          <td style="text-align:center"><span class="badge {{ 'ok' if u['status']=='active' else '' }}">{{ u['status'] }}</span></td>
          <td style="text-align:center">
            <a class="btn btn-sm" href="{{ url_for('edit_staff', user_id=u['user_id']) }}" style="margin-right:8px;">Edit</a>

            {% if u['status'] == 'active' %}
              <button class="btn secondary btn-sm" onclick="openConfirmModal('deactivate', {{ u['user_id'] }}, '{{ (u['first_name'] + ' ' + (u['last_name'] or ''))|escape }}')">Deactivate</button>
            {% else %}
              <form method="post" action="{{ url_for('restore_staff', user_id=u['user_id']) }}" style="display:inline">
                <button class="btn btn-sm" type="submit">Restore</button>
              </form>
            {% endif %}
          </td>
        </tr>
      {% endfor %}
      </tbody>
    </table>
  {% else %}
    <p class="small">No staff members yet.</p>
  {% endif %}
</div>

<!-- Confirmation modal (same as used in students.html) -->
<div id="confirmModal" style="display:none" class="modal-overlay" aria-hidden="true">
  <div class="modal-card">
    <h3 id="modalTitle">Confirm</h3>
    <p id="modalBody">Are you sure?</p>
    <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:16px">
      <button class="btn secondary" onclick="closeConfirmModal()">Cancel</button>
      <form id="modalForm" method="post" action="">
        <button class="btn" type="submit" id="modalConfirmBtn">Yes, proceed</button>
      </form>
    </div>
  </div>
</div>

<script>
  // Filter form auto-submit
  document.getElementById('statusFilter').addEventListener('change', function(){
    document.getElementById('filterForm').submit();
  });

  // Modal behavior
  function openConfirmModal(action, id, name){
    const modal = document.getElementById('confirmModal');
    const title = document.getElementById('modalTitle');
    const body = document.getElementById('modalBody');
    const form = document.getElementById('modalForm');

    if(action === 'deactivate'){
      title.textContent = 'Deactivate staff';
      body.textContent = "Are you sure you want to deactivate " + name + "? This will mark their account as inactive.";
      form.action = '/librarian/staff/deactivate/' + id;
      document.getElementById('modalConfirmBtn').textContent = 'Deactivate';
    }
    modal.style.display = 'flex';
    modal.setAttribute('aria-hidden','false');
  }

  function closeConfirmModal(){
    const modal = document.getElementById('confirmModal');
    modal.style.display = 'none';
    modal.setAttribute('aria-hidden','true');
  }

  document.getElementById('confirmModal').addEventListener('click', function(e){
    if(e.target === this) closeConfirmModal();
  });
</script>

{% endblock %}
